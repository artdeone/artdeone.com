<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - ART de ONE</title>
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/ddkd9lxpr/image/upload/v1769316272/fav-icon_n00lji.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{
            --primary-black:#000;--primary-white:#fff;--accent-green:#a7e169;
            --accent-red:#ed2939;--gray-50:#f9f9f9;--gray-200:#e5e5e5;--gray-900:#323232;
            --ease:cubic-bezier(.4,0,.2,1);
        }
        body{font-family:'Poppins',sans-serif;background:var(--gray-50);min-height:100vh;color:var(--gray-900);-webkit-font-smoothing:antialiased}

        .grain-btn{position:relative;overflow:hidden;isolation:isolate}
        .grain-btn::after{
            content:'';position:absolute;inset:0;z-index:1;pointer-events:none;border-radius:inherit;
            opacity:.07;mix-blend-mode:overlay;
            background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='g'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23g)'/%3E%3C/svg%3E");
            background-size:128px 128px;
        }
        .grain-btn:hover::after{opacity:.10}

        .reset-section{display:flex;min-height:100vh}
        .reset-left{flex:1;background:#000;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
        .reset-left video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
        .reset-right{flex:1;display:flex;align-items:center;justify-content:center;padding:40px;background:var(--primary-white)}

        .reset-card{max-width:420px;width:100%;animation:cardIn .6s var(--ease) both}
        @keyframes cardIn{from{opacity:0;transform:translateY(24px) scale(.97)}to{opacity:1;transform:translateY(0) scale(1)}}
        .logo-wrap{text-align:center;margin-bottom:28px}
        .logo-wrap img{height:40px}
        .reset-card h2{text-align:center;margin-bottom:10px;font-family:'Space Grotesk',sans-serif;font-size:1.4em;font-weight:700;letter-spacing:-.02em;color:var(--primary-black)}
        .reset-subtitle{text-align:center;color:#999;font-size:.88em;margin-bottom:28px;line-height:1.6}

        .auth-form-group{margin-bottom:12px}
        .auth-input{
            width:100%;padding:14px 16px;border:1.5px solid var(--gray-200);border-radius:12px;
            font-family:'Poppins',sans-serif;font-size:.9em;transition:all .3s var(--ease);
            background:var(--gray-50);color:var(--gray-900);
        }
        .auth-input:hover{border-color:#ccc}
        .auth-input:focus{outline:none;border-color:var(--accent-green);box-shadow:0 0 0 4px rgba(167,225,105,.12);background:var(--primary-white)}
        .auth-input::placeholder{color:#bbb}

        .password-rules{margin-bottom:16px;padding-left:2px}
        .password-rules p{font-size:.76em;color:#ccc;margin-bottom:4px;transition:color .3s var(--ease)}
        .password-rules p.valid{color:#16a34a}

        .btn-update{
            width:100%;padding:15px 24px;
            background:var(--primary-black);color:var(--primary-white);
            border:1px solid var(--primary-black);border-radius:2rem;
            font-family:'Poppins',sans-serif;font-size:.95em;font-weight:600;
            cursor:pointer;transition:all .3s ease;margin-top:4px;
            box-shadow:inset 0 0 12px 3px rgba(255,255,255,.18),inset 0 0 28px 6px rgba(255,255,255,.06),0 0 18px 4px rgba(0,0,0,.06);
        }
        .btn-update:hover{
            background:var(--accent-green);border-color:var(--accent-green);color:#000;transform:translateY(-2px);
            box-shadow:inset 0 0 14px 4px rgba(255,255,255,.45),inset 0 0 32px 8px rgba(255,255,255,.15),0 0 25px 6px rgba(167,225,105,.18);
        }
        .btn-update:active{transform:scale(.98)}
        .btn-update:disabled{opacity:.4;cursor:not-allowed;transform:none!important;box-shadow:none}
        .btn-update .btn-loading{display:none}
        .btn-update.loading .btn-text{display:none}
        .btn-update.loading .btn-loading{display:inline-flex;align-items:center;gap:8px}

        .btn-back{
            width:100%;padding:14px 24px;
            background:transparent;color:#999;
            border:1.5px solid var(--gray-200);border-radius:2rem;
            font-family:'Poppins',sans-serif;font-size:.9em;font-weight:500;
            cursor:pointer;transition:all .3s ease;margin-top:8px;
            text-decoration:none;display:block;text-align:center;
        }
        .btn-back:hover{border-color:var(--accent-green);color:var(--primary-black);transform:translateY(-1px)}

        .reset-error{
            color:var(--accent-red);font-size:.82em;text-align:center;margin-bottom:16px;display:none;
            animation:errorShake .4s var(--ease);background:#fff5f5;padding:10px 16px;border-radius:8px;
            border:1px solid rgba(237,41,57,.08);
        }
        @keyframes errorShake{0%,100%{transform:translateX(0)}20%{transform:translateX(-6px)}40%{transform:translateX(6px)}60%{transform:translateX(-3px)}80%{transform:translateX(3px)}}

        .loading-state{text-align:center;padding:40px 20px}
        .loading-state .spinner{width:36px;height:36px;border:3px solid var(--gray-200);border-top-color:var(--accent-green);border-radius:50%;animation:spin .7s linear infinite;margin:0 auto 16px}
        .loading-state p{color:#999;font-size:.88em}
        @keyframes spin{to{transform:rotate(360deg)}}

        .success-box{text-align:center;padding:24px 0;animation:fadeSlideUp .5s var(--ease) both}
        .success-box .success-icon{font-size:2.8em;margin-bottom:16px;display:block}
        .success-box h3{font-family:'Space Grotesk',sans-serif;font-size:1.1em;font-weight:700;margin-bottom:8px;color:var(--primary-black)}
        .success-box p{color:#999;font-size:.85em;line-height:1.7}
        @keyframes fadeSlideUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}

        .error-state{text-align:center;padding:24px 0;animation:fadeSlideUp .5s var(--ease) both}
        .error-state .error-icon{font-size:2.8em;margin-bottom:16px;display:block}
        .error-state h3{font-family:'Space Grotesk',sans-serif;font-size:1.1em;font-weight:700;margin-bottom:8px;color:var(--accent-red)}
        .error-state p{color:#999;font-size:.85em;line-height:1.7}

        .view-hidden{display:none!important}

        .contact-footer{margin-top:24px;padding-top:20px;border-top:1px solid #f0f0f0;text-align:center;font-size:.78em;color:#999;line-height:1.8}
        .contact-footer a{color:#323232;font-weight:600;text-decoration:none}

        @media(max-width:600px){
            .reset-section{flex-direction:column}
            .reset-left{flex:none;height:35vh;min-height:200px}
            .reset-right{flex:1;padding:32px 24px}
            .reset-card{max-width:100%}
            .reset-card h2{font-size:1.25em}
        }
    </style>
</head>
<body>

<div class="reset-section">
    <div class="reset-left">
        <video autoplay muted loop playsinline>
            <source src="https://res.cloudinary.com/ddkd9lxpr/video/upload/v1771427098/change-password_wd7fw3.mp4" type="video/mp4">
        </video>
    </div>
    <div class="reset-right">
        <div class="reset-card">
            <div class="logo-wrap">
                <img src="https://res.cloudinary.com/ddkd9lxpr/image/upload/v1768125759/logo-green_wzaqzh.png" alt="ART de ONE">
            </div>

            <!-- 1. Loading State -->
            <div id="loadingState" class="loading-state">
                <div class="spinner"></div>
                <p>Verifying your reset link...</p>
            </div>

            <!-- 2. Reset Form -->
            <div id="resetFormView" class="view-hidden">
                <h2>Password အသစ် သတ်မှတ်ပါ</h2>
                <p class="reset-subtitle">Password အသစ် ထည့်သွင်းပါ</p>

                <div class="reset-error" id="resetError"></div>

                <div class="auth-form-group">
                    <input type="password" id="newPassword" class="auth-input" 
                           placeholder="Password အသစ်" oninput="checkPassword()">
                </div>
                <div class="auth-form-group">
                    <input type="password" id="confirmPassword" class="auth-input" 
                           placeholder="Password ပြန်ထည့်ပါ" oninput="checkPassword()">
                </div>

                <div class="password-rules">
                    <p id="ruleLength"><i class="fas fa-times" style="width:14px;font-size:.7em;"></i> အနည်းဆုံး စာလုံး ၆ လုံး</p>
                    <p id="ruleMatch"><i class="fas fa-times" style="width:14px;font-size:.7em;"></i> Password နှစ်ခု တူညီရပါမယ်</p>
                </div>

                <button class="btn-update grain-btn" id="btnUpdate" onclick="updatePassword()" disabled>
                    <span class="btn-text">Update Password</span>
                    <span class="btn-loading"><i class="fas fa-spinner fa-spin"></i> Updating...</span>
                </button>

                <a href="/customer-dashboard.html" class="btn-back">Back to Login</a>
            </div>

            <!-- 3. Success -->
            <div id="successView" class="view-hidden">
                <div class="success-box">
                    <span class="success-icon">✅</span>
                    <h3>Password ပြောင်းပြီးပါပြီ!</h3>
                    <p>Password အသစ်ဖြင့် Login ပြန်၀င်နိုင်ပါပြီ</p>
                </div>
                <a href="/customer-dashboard.html" class="btn-back" style="border-color:var(--accent-green);color:var(--primary-black);">
                    <i class="fas fa-arrow-left" style="margin-right:6px;"></i>Login Page သို့ ပြန်သွားမည်
                </a>
            </div>

            <!-- 4. Error / Expired -->
            <div id="errorView" class="view-hidden">
                <div class="error-state">
                    <span class="error-icon">⚠️</span>
                    <h3>Link မမှန်ကန်ပါ</h3>
                    <p>Reset Link သက်တမ်းကုန်သွားပါပြီ။<br>ထပ်မံ request လုပ်ပါ</p>
                </div>
                <a href="/customer-dashboard.html" class="btn-back">
                    <i class="fas fa-arrow-left" style="margin-right:6px;"></i>Login Page သို့ ပြန်သွားမည်
                </a>
            </div>

            <div class="contact-footer">
                Contact : <a href="mailto:artdeone.educators@gmail.com">artdeone.educators@gmail.com</a>
            </div>
        </div>
    </div>
</div>

<!-- Supabase SDK - MUST load before our script -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    // Wait for everything to load
    window.addEventListener('DOMContentLoaded', function() {
        init();
    });

    var supabaseClient = null;
    var recoveryReady = false;

    function showView(viewId) {
        ['loadingState', 'resetFormView', 'successView', 'errorView'].forEach(function(id) {
            var el = document.getElementById(id);
            if (el) {
                if (id === viewId) {
                    el.classList.remove('view-hidden');
                    el.style.display = '';
                } else {
                    el.classList.add('view-hidden');
                }
            }
        });
    }

    function init() {
        var hash = window.location.hash;
        console.log('Hash:', hash);
        console.log('Has recovery:', hash && hash.indexOf('type=recovery') !== -1);

        // Check if URL has recovery token
        if (!hash || hash.indexOf('type=recovery') === -1) {
            showView('errorView');
            return;
        }

        // Show loading
        showView('loadingState');

        // Try to init Supabase
        try {
            if (typeof window.supabase === 'undefined') {
                console.error('Supabase SDK not loaded');
                // Wait a bit and retry
                setTimeout(function() {
                    if (typeof window.supabase !== 'undefined') {
                        initSupabase();
                    } else {
                        console.error('Supabase SDK still not loaded');
                        showView('resetFormView');
                    }
                }, 2000);
                return;
            }

            initSupabase();

        } catch (err) {
            console.error('Init error:', err);
            // Show form anyway as fallback
            showView('resetFormView');
        }
    }

    function initSupabase() {
    try {
        supabaseClient = window.supabase.createClient(
            'https://eyhyvlszpfsmsjyzijxg.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV5aHl2bHN6cGZzbXNqeXppanhnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5NTg4NjQsImV4cCI6MjA4MzUzNDg2NH0.bU0BGIe1qVXMFa7dJY3GjhVHBFKJOHpqXZkamPrfpYE'
        );

        console.log('Supabase client created');

        // *** ဒါအသစ်ထည့်ပါ - Hash ထဲက token ကို manually set လုပ်ပါ ***
        var hash = window.location.hash.substring(1);
        var params = new URLSearchParams(hash);
        var accessToken = params.get('access_token');
        var refreshToken = params.get('refresh_token');

        if (accessToken && refreshToken) {
            supabaseClient.auth.setSession({
                access_token: accessToken,
                refresh_token: refreshToken
            }).then(function(result) {
                console.log('Session set result:', result);
                if (result.error) {
                    console.error('Session error:', result.error);
                    showView('errorView');
                } else {
                    recoveryReady = true;
                    showView('resetFormView');
                }
            });
        } else {
            console.error('No tokens found in URL');
            showView('errorView');
        }

    } catch (err) {
        console.error('Supabase init error:', err);
        showView('errorView');
    }
}

    function checkPassword() {
        var password = document.getElementById('newPassword').value;
        var confirm = document.getElementById('confirmPassword').value;
        var btnUpdate = document.getElementById('btnUpdate');
        var ruleLength = document.getElementById('ruleLength');
        var ruleMatch = document.getElementById('ruleMatch');

        var isLong = password.length >= 6;
        var isMatch = password === confirm && confirm.length > 0;

        ruleLength.innerHTML = '<i class="fas fa-' + (isLong ? 'check' : 'times') + '" style="width:14px;font-size:.7em;"></i> အနည်းဆုံး စာလုံး ၆ လုံး';
        ruleLength.className = isLong ? 'valid' : '';

        ruleMatch.innerHTML = '<i class="fas fa-' + (isMatch ? 'check' : 'times') + '" style="width:14px;font-size:.7em;"></i> Password နှစ်ခု တူညီရပါမယ်';
        ruleMatch.className = isMatch ? 'valid' : '';

        btnUpdate.disabled = !(isLong && isMatch);
    }

    function updatePassword() {
        var password = document.getElementById('newPassword').value;
        var btn = document.getElementById('btnUpdate');
        var errorBox = document.getElementById('resetError');

        if (!supabaseClient) {
            errorBox.textContent = 'Connection error. Page ကို refresh လုပ်ပြီး ထပ်ကြိုးစားပါ။';
            errorBox.style.display = 'block';
            return;
        }

        btn.classList.add('loading');
        btn.disabled = true;
        errorBox.style.display = 'none';

        supabaseClient.auth.updateUser({ password: password })
            .then(function(result) {
                if (result.error) {
                    throw result.error;
                }

                // Success!
                showView('successView');

                // Auto redirect after 4 seconds
                setTimeout(function() {
                    window.location.href = '/customer-dashboard.html';
                }, 4000);
            })
            .catch(function(err) {
                console.error('Update error:', err);
                errorBox.textContent = err.message || 'Error ဖြစ်ပါတယ်။ ထပ်ကြိုးစားပါ။';
                errorBox.style.display = 'block';
                errorBox.style.animation = 'none';
                errorBox.offsetHeight;
                errorBox.style.animation = 'errorShake .4s var(--ease)';
                btn.classList.remove('loading');
                btn.disabled = false;
            });
    }

    // Enter key support
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            var btn = document.getElementById('btnUpdate');
            if (btn && !btn.disabled && !document.getElementById('resetFormView').classList.contains('view-hidden')) {
                updatePassword();
            }
        }
    });
</script>

</body>
</html>
