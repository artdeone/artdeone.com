<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logging in â€” ART de ONE</title>
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/ddkd9lxpr/image/upload/v1769316272/fav-icon_n00lji.png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; background: #fafafa;
            font-family: 'Space Grotesk', Arial, sans-serif;
        }
        .container { text-align: center; }
        .logo { width: 120px; margin-bottom: 40px; }
        .bar-wrapper {
            width: 200px; height: 2px; background: #e0e0e0;
            margin: 0 auto 24px; border-radius: 2px; overflow: hidden;
        }
        .bar {
            width: 40%; height: 100%; background: #222;
            border-radius: 2px;
            animation: slide 1.2s ease-in-out infinite;
        }
        @keyframes slide {
            0%   { transform: translateX(-100%); }
            100% { transform: translateX(350%); }
        }
        .text { font-size: 14px; color: #888; }
        .error {
            display: none; margin-top: 20px;
            font-size: 13px; color: #c0392b;
            max-width: 300px; margin: 20px auto 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <img src="https://res.cloudinary.com/ddkd9lxpr/image/upload/v1768125759/logo-green_wzaqzh.png"
             alt="ART de ONE" class="logo">
        <div class="bar-wrapper"><div class="bar"></div></div>
        <p class="text" id="statusText">Logging in</p>
        <p class="error" id="errorMsg"></p>
    </div>

    <script type="module">
        import { supabaseShop, findOrCreateCustomer } from '/js/config-shop.js';
        // âœ… á€’á€® 3 lines á€‘á€•á€ºá€‘á€Šá€·á€ºá€•á€« â€” á€¡á€•á€±á€«á€ºá€†á€¯á€¶á€¸á€™á€¾á€¬
        console.log('ðŸ“ Full URL:', window.location.href);
        console.log('ðŸ“ Search params:', window.location.search);
        console.log('ðŸ“ Hash:', window.location.hash);

        async function handleCallback() {
            const statusText = document.getElementById('statusText');
            const errorMsg   = document.getElementById('errorMsg');

            try {
                /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                   Step 1: PKCE flow â€” ?code= á€…á€…á€ºá€•á€«
                â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
                const params = new URLSearchParams(window.location.search);
                const code   = params.get('code');

                if (code) {
                    statusText.textContent = 'Exchanging code...';
                    console.log('ðŸ”‘ PKCE code found, exchanging...');

                    const { data, error } =
                        await supabaseShop.auth.exchangeCodeForSession(code);

                    if (error) {
                        console.error('Exchange error:', error);
                        throw error;
                    }

                    if (data?.session?.user) {
                        console.log('âœ… Session from PKCE:', data.session.user.email);
                        await setupAndRedirect(data.session);
                        return;
                    }
                }

                /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                   Step 2: Hash fragment flow â€” #access_token= á€…á€…á€ºá€•á€«
                â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
                const hash = window.location.hash;
                if (hash && hash.includes('access_token')) {
                    statusText.textContent = 'Processing token...';
                    console.log('ðŸ”‘ Hash fragment found');

                    // Supabase auto-detects hash, just wait a bit
                    await new Promise(r => setTimeout(r, 1000));
                }

                /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                   Step 3: getSession á€…á€…á€ºá€•á€«
                â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
                statusText.textContent = 'Verifying session...';
                const { data: { session }, error: sessionError } =
                    await supabaseShop.auth.getSession();

                if (sessionError) throw sessionError;

                if (session?.user) {
                    console.log('âœ… Session found:', session.user.email);
                    await setupAndRedirect(session);
                    return;
                }

                /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                   Step 4: Wait for auth state change
                â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
                statusText.textContent = 'Waiting for authentication...';
                console.log('â³ Waiting for onAuthStateChange...');

                const waitedSession = await new Promise((resolve, reject) => {
                    const timer = setTimeout(
                        () => reject(new Error('Auth timeout â€” no session received')),
                        10000
                    );
                    supabaseShop.auth.onAuthStateChange((event, sess) => {
                        console.log('ðŸ”” Auth event:', event);
                        if (event === 'SIGNED_IN' && sess) {
                            clearTimeout(timer);
                            resolve(sess);
                        }
                    });
                });

                if (waitedSession?.user) {
                    await setupAndRedirect(waitedSession);
                    return;
                }

                throw new Error('No session found after all attempts');

            } catch (err) {
                console.error('âŒ Callback error:', err);
                statusText.style.display = 'none';
                document.querySelector('.bar-wrapper').style.display = 'none';
                errorMsg.textContent = err.message || 'Unable to sign in. Redirecting...';
                errorMsg.style.display = 'block';
                setTimeout(() => {
                    window.location.href = '/customer-dashboard.html';
                }, 3000);
            }
        }

        async function setupAndRedirect(session) {
            const statusText = document.getElementById('statusText');

            statusText.textContent = 'Setting up account...';
            console.log('ðŸ‘¤ Setting up customer for:', session.user.email);

            try {
                const customer = await findOrCreateCustomer(session.user);
                localStorage.setItem('customer',   JSON.stringify(customer));
                localStorage.setItem('user_email',  session.user.email);
                localStorage.setItem('user_name',
                    session.user.user_metadata?.full_name || '');

                console.log('âœ… Customer ready, redirecting...');
                statusText.textContent = 'Redirecting...';
                window.location.href = '/customer-dashboard.html';

            } catch (dbErr) {
                console.error('DB error:', dbErr);
                // DB error á€–á€¼á€…á€ºá€›á€„á€ºá€œá€Šá€ºá€¸ session á€›á€¾á€­á€›á€„á€º redirect á€œá€¯á€•á€º
                localStorage.setItem('user_email', session.user.email);
                localStorage.setItem('user_name',
                    session.user.user_metadata?.full_name || '');
                window.location.href = '/customer-dashboard.html';
            }
        }

        handleCallback();
    </script>
</body>
</html>