<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="robots" content="noindex, nofollow">
    <title>Designer Admin - ART de ONE</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --primary-black: #111; --primary-white: #fff; --accent-green: #a7e169; --accent-red: #ed2939; --gray-50: #fcfcfc; --gray-100: #f4f4f5; --gray-200: #e4e4e7; }
        body { font-family: 'Poppins', sans-serif; background: var(--gray-50); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Navbar */
        .navbar { 
            height: 60px;
            background: white; 
            border-bottom: 1px solid var(--gray-200); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 0 16px; 
            z-index: 50; 
        }
        
        .logo { display: flex; align-items: center; }
        .logo img { 
            height: 32px;
            width: auto;
            object-fit: contain;
            display: block;
        }

        .nav-links { display: flex; gap: 6px; }
        
        .btn { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; font-size: 0.85em; transition: 0.2s; white-space: nowrap; }
        .btn-nav { background: transparent; color: #666; }
        .btn-nav.active { background-color: var(--accent-red) !important; color: white !important; }
        .btn-red { background-color: var(--accent-red) !important; color: white !important; }
        .btn-logout { background: #ffe4e6; color: var(--accent-red); margin-left: 4px; }
        
        /* Layout */
        .admin-container { display: flex; flex: 1; overflow: hidden; position: relative; }
        .sidebar { width: 350px; background: white; border-right: 1px solid var(--gray-200); display: flex; flex-direction: column; }
        .main-content { flex: 1; padding: 20px; overflow-y: auto; background: var(--gray-50); }
        
        /* Request List */
        .req-item { padding: 16px; border-bottom: 1px solid var(--gray-100); cursor: pointer; transition: 0.2s; margin: 0; }
        .req-item.status-pending { background: #fffbeb; border-left: 4px solid #f59e0b; }
        .req-item.status-approved { background: #ecfdf5; border-left: 4px solid #10b981; }
        .req-item.status-completed { background: #eff6ff; border-left: 4px solid #3b82f6; opacity: 0.7; }
        
        .detail-card { background: white; padding: 24px; border-radius: 12px; border: 1px solid var(--gray-200); max-width: 800px; margin: 0 auto; }
        
        /* Client Table */
        .client-table { width: 100%; border-collapse: collapse; background: white; }
        .client-table th { background: var(--gray-50); padding: 12px; text-align: left; font-size: 0.8em; color: #666; }
        .client-table td { padding: 12px; border-bottom: 1px solid #eee; font-size: 0.9em; }
        
        /* Inactive Row Style */
        .client-table tr.inactive-client { opacity: 0.5; background: #f9f9f9; }
        
        /* Action Buttons */
        .action-btn { 
            padding: 5px 10px; 
            margin-right: 5px; 
            border: none; 
            background: #f0f0f0; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 0.8em; 
            transition: 0.2s;
        }
        .action-btn:hover { background: #e0e0e0; }
        .action-btn.complete { background: #dbeafe; color: #1e40af; }
        .action-btn.reactivate { background: #d1fae5; color: #065f46; }
        
        /* Filter Tabs */
        .filter-tabs { display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 5px; }
        .filter-tab { padding: 6px 14px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85em; background: #eee; white-space: nowrap; }
        .filter-tab.active { background: var(--accent-red); color: white; }

        /* Mobile */
        @media (max-width: 768px) {
            .navbar { padding: 0 12px; height: 56px; }
            .logo img { height: 28px; }
            .nav-links { gap: 4px; }
            .btn { padding: 6px 10px; font-size: 0.75em; }
            .sidebar { width: 100%; position: absolute; z-index: 20; height: 100%; }
            .main-content { width: 100%; position: absolute; z-index: 30; transform: translateX(100%); transition: 0.3s; background: white; padding: 16px; }
            .main-content.active-mobile { transform: translateX(0); }
            .mobile-back { display: block; margin-bottom: 15px; cursor: pointer; font-weight: bold; color: #666; }
        }
        .mobile-back { display: none; }
        .hidden { display: none !important; }
        .badge-count { background: white; color: var(--accent-red); font-weight:bold; font-size: 0.7em; padding: 2px 5px; border-radius: 8px; margin-left: 3px; }
    </style>
</head>
<body>
    <!-- Login -->
    <div id="loginSection" style="position:fixed; inset:0; background:#fcfcfc; z-index:100; display:flex; justify-content:center; align-items:center;">
        <div style="background:white; padding:40px; border:1px solid #eee; border-radius:12px; text-align:center; width: 350px; box-shadow: 0 10px 30px rgba(0,0,0,0.05);">
            <img src="https://res.cloudinary.com/ddkd9lxpr/image/upload/v1768125759/logo-green_wzaqzh.png" alt="ART de ONE" style="height: 50px; margin-bottom: 20px;">
            <h2 style="font-family:'Space Grotesk'; margin-bottom:10px;">Designer Portal</h2>
            <input type="password" id="accessCode" placeholder="Access Code" style="padding:12px; margin-bottom:20px; width:100%; border:1px solid #ddd; border-radius:8px;">
            <button onclick="handleLogin()" class="btn" style="background:var(--accent-green); color:black; width:100%; padding:12px; font-size:1em;">Login</button>
        </div>
    </div>

    <!-- App -->
    <div id="appSection" class="hidden" style="height:100%; display:flex; flex-direction:column;">
        <nav class="navbar">
            <div class="logo">
                <img src="https://res.cloudinary.com/ddkd9lxpr/image/upload/v1768125759/logo-green_wzaqzh.png" alt="ART de ONE">
            </div>
            <div class="nav-links">
                <button onclick="switchView('requests')" id="nav-requests" class="btn btn-nav active">Requests</button>
                <button onclick="switchView('renewals')" id="nav-renewals" class="btn btn-nav">Renewals <span id="renewBadge" class="badge-count hidden">0</span></button>
                <button onclick="switchView('clients')" id="nav-clients" class="btn btn-nav">Clients</button>
                <button onclick="logout()" class="btn btn-logout">Exit</button>
            </div>
        </nav>

        <!-- 1. REQUESTS -->
        <div id="view-requests" class="admin-container">
            <div class="sidebar">
                <div style="padding:12px 16px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items: center;">
                    <strong style="font-size: 0.9em;">Queue</strong>
                    <button onclick="loadData()" class="btn" style="background:#a7e169; color:black; padding:4px 10px; font-size:0.75em;">Refresh</button>
                </div>
                <div id="requestList" style="flex:1; overflow-y:auto;">Loading...</div>
            </div>
            <div class="main-content" id="reqDetailView">
                <div class="mobile-back" onclick="closeMobileDetail()">← Back to List</div>
                <div id="emptyState" style="text-align:center; margin-top:100px; color:#999; font-size: 0.9em;">Select a request to view details</div>
                <div id="requestDetail" class="hidden detail-card"></div>
            </div>
        </div>

        <!-- 2. RENEWALS -->
        <div id="view-renewals" class="hidden" style="flex:1; padding:20px; overflow-y:auto;">
            <div style="max-width:800px; margin:0 auto;">
                <h3 style="margin-bottom:15px; font-family:'Space Grotesk';">Renewals</h3>
                <div id="renewList"></div>
            </div>
        </div>

        <!-- 3. CLIENTS -->
        <div id="view-clients" class="hidden" style="flex:1; padding:20px; overflow-y:auto;">
            <div style="max-width:1000px; margin:0 auto;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 style="font-family:'Space Grotesk';">Clients</h3>
                    <button onclick="openAddClientModal()" class="btn btn-red">+ Add Client</button>
                </div>
                
                <div class="filter-tabs">
                    <div class="filter-tab active" onclick="filterClients('all')">All</div>
                    <div class="filter-tab" onclick="filterClients('active')">Active</div>
                    <div class="filter-tab" onclick="filterClients('inactive')">Completed</div>
                </div>

                <div style="background:white; border:1px solid #eee; border-radius:12px; overflow:hidden;">
                    <div style="overflow-x: auto;">
                        <table class="client-table">
                            <thead><tr><th>Status</th><th>Name</th><th>Email</th><th>Pkg</th><th>Revs</th><th>Action</th></tr></thead>
                            <tbody id="clientListBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Client Modal -->
    <div id="clientModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:200;">
        <div style="background:white; padding:24px; border-radius:12px; width:90%; max-width:400px;">
            <h3 style="margin-bottom: 15px;">Add Client</h3>
            <form id="clientForm" style="display:grid; gap:12px;">
                <input type="hidden" id="clientId">
                <input type="text" id="cName" placeholder="Name" required style="padding:10px; border:1px solid #ddd; border-radius:6px; font-size: 0.9em;">
                <input type="email" id="cEmail" placeholder="Email" required style="padding:10px; border:1px solid #ddd; border-radius:6px; font-size: 0.9em;">
                <input type="text" id="cPhone" placeholder="Phone" required style="padding:10px; border:1px solid #ddd; border-radius:6px; font-size: 0.9em;">
                <select id="cPackage" style="padding:10px; border:1px solid #ddd; border-radius:6px; font-size: 0.9em;" onchange="updateDefaults()">
                    <option value="essential">Essential</option><option value="professional">Professional</option><option value="freedom">Freedom</option>
                </select>
                <div style="display:flex; gap:10px;">
                    <input type="number" id="cRevs" placeholder="Revs" style="padding:10px; width:50%; border:1px solid #ddd; border-radius:6px; font-size: 0.9em;">
                    <input type="number" id="cMonths" value="1" placeholder="Mo" style="padding:10px; width:50%; border:1px solid #ddd; border-radius:6px; font-size: 0.9em;">
                </div>
                <button type="submit" class="btn" style="background:black; color:white; padding: 12px;">Save Client</button>
                <button type="button" onclick="document.getElementById('clientModal').style.display='none'" style="background:none; border:none; cursor:pointer; font-size: 0.9em;">Cancel</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { supabaseRevision, verifyDesignerCode } from './js/config-revision.js';
        let requests = [], clients = [], renewRequests = [];
        let clientFilter = 'all';

        // Auth
        window.handleLogin = async () => {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Verifying...';
            const valid = await verifyDesignerCode(document.getElementById('accessCode').value);
            if (valid) {
                document.getElementById('loginSection').style.display='none';
                document.getElementById('appSection').classList.remove('hidden');
                loadData(); loadClients(); loadRenewals();
            } else {
                alert('Invalid access code');
                btn.disabled = false;
                btn.textContent = 'Login';
            }
        };
        window.logout = () => location.reload();

        // Navigation
        window.switchView = (view) => {
            ['requests','renewals','clients'].forEach(v => {
                document.getElementById(`view-${v}`).classList.add('hidden');
                document.getElementById(`view-${v}`).style.display = 'none';
                document.getElementById(`nav-${v}`).classList.remove('active');
            });
            const target = document.getElementById(`view-${view}`);
            target.classList.remove('hidden');
            target.style.display = view === 'requests' ? 'flex' : 'block';
            document.getElementById(`nav-${view}`).classList.add('active');
            
            if(view === 'renewals') loadRenewals();
            if(view === 'clients') loadClients();
        };

        // Requests
        window.loadData = async () => {
            const { data } = await supabaseRevision.from('revision_requests').select('*, clients(name, email)').order('created_at', {ascending:false});
            requests = data || [];
            renderList();
        };
        function renderList() {
            document.getElementById('requestList').innerHTML = requests.map(r => `
                <div class="req-item status-${r.status}" onclick="selectRequest('${r.id}')">
                    <div style="font-weight:600; font-size: 0.95em;">${r.project_name}</div>
                    <div style="font-size:0.85em; color:#666;">${r.clients?.name}</div>
                    <div style="font-size:0.75em; text-transform:uppercase; margin-top:4px; font-weight:bold; opacity: 0.8;">${r.status}</div>
                </div>
            `).join('');
        }
        window.selectRequest = (id) => {
            const r = requests.find(x => x.id === id);
            if(window.innerWidth <= 768) {
                document.getElementById('reqDetailView').classList.add('active-mobile');
                document.querySelector('.mobile-back').style.display = 'block';
            }
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('requestDetail').classList.remove('hidden');
            document.getElementById('requestDetail').innerHTML = `
                <h2 style="font-size: 1.2em;">${r.project_name}</h2>
                <p style="font-size: 0.9em; color: #555;">Client: ${r.clients?.name}</p>
                <p style="margin:16px 0; line-height: 1.5; font-size: 0.95em;">${r.description}</p>
                <a href="${r.file_url}" target="_blank" style="font-size: 0.9em; text-decoration: underline;">View Attached File</a>
                <div style="margin-top:24px; border-top:1px solid #eee; padding-top:16px;">
                    ${r.status==='pending' ? `<button class="btn" style="background:#d1fae5; color:green;" onclick="updateStatus('${r.id}','approved')">Accept Request</button>` : ''}
                    ${r.status==='approved' ? `<button class="btn" style="background:#dbeafe; color:blue;" onclick="markComplete('${r.id}','${r.client_id}')">Mark Complete (-1 Rev)</button>` : ''}
                    ${r.status==='completed' ? `<span style="color:#3b82f6; font-size:0.9em;">✓ Completed</span>` : ''}
                </div>
            `;
        };
        window.closeMobileDetail = () => {
            document.getElementById('reqDetailView').classList.remove('active-mobile');
            document.querySelector('.mobile-back').style.display = 'none';
        };
        
        window.updateStatus = async (id, status) => { await supabaseRevision.from('revision_requests').update({status}).eq('id',id); loadData(); selectRequest(id); };
        window.markComplete = async (rid, cid) => {
            if(!confirm('Deduct 1 revision?')) return;
            await supabaseRevision.from('revision_requests').update({status:'completed'}).eq('id',rid);
            const {data:c} = await supabaseRevision.from('clients').select('revisions_used, revisions_remaining').eq('id',cid).single();
            await supabaseRevision.from('clients').update({revisions_used: c.revisions_used+1, revisions_remaining: c.revisions_remaining-1}).eq('id',cid);
            loadData(); selectRequest(rid);
        };

        // Renewals
        window.loadRenewals = async () => {
            const { data } = await supabaseRevision.from('renew_requests').select('*, clients(name, email, package_type)').eq('status','pending');
            renewRequests = data || [];
            document.getElementById('renewBadge').innerText = renewRequests.length;
            document.getElementById('renewBadge').classList.toggle('hidden', renewRequests.length === 0);
            document.getElementById('renewList').innerHTML = renewRequests.length ? renewRequests.map(r => `
                <div style="background:white; border:1px solid #eee; padding:16px; border-radius:8px; margin-bottom:12px; display:flex; justify-content:space-between; align-items:center;">
                    <div><h4 style="margin:0;">${r.requested_package.toUpperCase()}</h4><p style="font-size:0.85em; color:#666; margin:2px 0;">${r.clients?.name}</p></div>
                    <button onclick="approveRenew('${r.id}','${r.client_id}','${r.requested_package}')" class="btn" style="background:#a7e169; color:black; font-size:0.8em;">Accept</button>
                </div>
            `).join('') : '<p style="text-align:center; color:#999; font-size:0.9em;">No pending renewals</p>';
        };
        window.approveRenew = async (rid, cid, pkg) => {
            if(!confirm('Activate renewal?')) return;
            const revs = pkg==='essential'?5:(pkg==='professional'?15:1000);
            const date = new Date(); date.setMonth(date.getMonth()+1);
            const {data:c} = await supabaseRevision.from('clients').select('revisions_remaining, revisions_total').eq('id',cid).single();
            await supabaseRevision.from('clients').update({package_type:pkg, revisions_total:c.revisions_total+revs, revisions_remaining:c.revisions_remaining+revs, package_end_date:date.toISOString(), is_active:true}).eq('id',cid);
            await supabaseRevision.from('renew_requests').update({status:'completed'}).eq('id',rid);
            loadRenewals(); loadClients();
        };

        // Clients
        window.loadClients = async () => {
            const { data } = await supabaseRevision.from('clients').select('*').order('created_at',{ascending:false});
            clients = data || [];
            renderClients();
        };
        
        function renderClients() {
            let filtered = clients;
            if(clientFilter === 'active') filtered = clients.filter(c => c.is_active);
            if(clientFilter === 'inactive') filtered = clients.filter(c => !c.is_active);
            
            document.getElementById('clientListBody').innerHTML = filtered.map(c => `
                <tr class="${c.is_active ? '' : 'inactive-client'}">
                    <td><span style="display:inline-block; width:6px; height:6px; border-radius:50%; background:${c.is_active?'#10b981':'#ef4444'}; margin-right:6px;"></span>${c.is_active?'Active':'Completed'}</td>
                    <td style="font-weight:500;">${c.name}</td>
                    <td>${c.email}</td>
                    <td>${c.package_type}</td>
                    <td>${c.revisions_remaining}</td>
                    <td>
                        <button onclick="editClient('${c.id}')" class="action-btn">Edit</button>
                        ${c.is_active ? 
                            `<button onclick="toggleClientStatus('${c.id}', false)" class="action-btn complete">Mark Complete</button>` : 
                            `<button onclick="toggleClientStatus('${c.id}', true)" class="action-btn reactivate">Reactivate</button>`
                        }
                    </td>
                </tr>
            `).join('');
        }
        
        // NEW: Toggle Client Status Function
        window.toggleClientStatus = async (id, newStatus) => {
            const action = newStatus ? 'reactivate' : 'mark as completed';
            if(!confirm(`Are you sure you want to ${action} this client?`)) return;
            
            await supabaseRevision.from('clients').update({ is_active: newStatus }).eq('id', id);
            loadClients();
        };
        
        window.filterClients = (filter) => {
            clientFilter = filter;
            document.querySelectorAll('.filter-tab').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            renderClients();
        };

        window.openAddClientModal = () => { document.getElementById('clientForm').reset(); document.getElementById('clientModal').style.display='flex'; };
        window.updateDefaults = () => { const p = document.getElementById('cPackage').value; document.getElementById('cRevs').value = p==='essential'?5:(p==='professional'?15:1000); };
        
        document.getElementById('clientForm').addEventListener('submit', async(e) => {
            e.preventDefault();
            const id = document.getElementById('clientId').value;
            const data = {
                name: document.getElementById('cName').value,
                email: document.getElementById('cEmail').value,
                phone: document.getElementById('cPhone').value,
                package_type: document.getElementById('cPackage').value,
                revisions_total: parseInt(document.getElementById('cRevs').value)
            };
            if(!id) {
                data.revisions_remaining = data.revisions_total;
                data.revisions_used = 0;
                data.is_active = true;
                const d = new Date(); d.setMonth(d.getMonth()+parseInt(document.getElementById('cMonths').value));
                data.package_end_date = d.toISOString();
                await supabaseRevision.from('clients').insert([data]);
            } else {
                await supabaseRevision.from('clients').update(data).eq('id',id);
            }
            document.getElementById('clientModal').style.display='none';
            loadClients();
        });
        window.editClient = (id) => {
            const c = clients.find(x=>x.id===id);
            document.getElementById('clientId').value=c.id;
            document.getElementById('cName').value=c.name;
            document.getElementById('cEmail').value=c.email;
            document.getElementById('cPhone').value=c.phone;
            document.getElementById('cPackage').value=c.package_type;
            document.getElementById('cRevs').value=c.revisions_total;
            document.getElementById('clientModal').style.display='flex';
        };
    </script>
</body>
</html>
