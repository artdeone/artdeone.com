<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Dashboard - ART de ONE</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary-black: #000000; --primary-white: #ffffff; --accent-green: #a7e169;
            --accent-red: #ed2939; --gray-50: #f9f9f9; --gray-100: #f3f4f6; --gray-200: #e5e7eb;
            --gray-400: #9ca3af; --gray-600: #555555; --gray-900: #323232;
        }
        body { font-family: 'Poppins', sans-serif; background: var(--gray-50); min-height: 100vh; color: var(--gray-900); }
        .top-nav { background: var(--primary-white); border-bottom: 1px solid var(--gray-200); padding: 15px 0; position: sticky; top: 0; z-index: 100; }
        .nav-container { max-width: 1400px; margin: 0 auto; padding: 0 30px; display: flex; justify-content: space-between; align-items: center; }
        .logo-section h1 { font-family: 'Space Grotesk', sans-serif; font-size: 1.25em; font-weight: 600; }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 30px; }
        .dashboard-header { background: white; padding: 30px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--gray-200); position: relative; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; border: 1px solid var(--gray-200); }
        .stat-card .number { font-size: 2em; font-weight: bold; font-family: 'Space Grotesk'; }
        
        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .form-section, .requests-section { background: white; padding: 30px; border-radius: 12px; border: 1px solid var(--gray-200); }
        .requests-section { max-height: 800px; overflow-y: auto; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-input { width: 100%; padding: 12px; border: 1px solid var(--gray-200); border-radius: 8px; font-family: 'Poppins'; }
        
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-primary { background: var(--accent-green); color: black; width: 100%; }
        .btn-primary:hover { background: #96d158; }

        /* Request Items */
        .request-item { border: 1px solid var(--gray-200); padding: 20px; border-radius: 10px; margin-bottom: 15px; transition: all 0.3s; }
        .request-item.status-pending { border-left: 5px solid #f59e0b; background: #fffbeb; }
        .request-item.status-approved { border-left: 5px solid #10b981; background: #ecfdf5; }
        .request-item.status-completed { border-left: 5px solid #3b82f6; background: #eff6ff; opacity: 0.8; }
        
        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal-overlay.active { display: flex; }
        .modal-box { background: white; padding: 30px; border-radius: 16px; width: 90%; max-width: 450px; text-align: center; }
        .pkg-card { border: 1px solid #eee; padding: 15px; border-radius: 8px; margin-bottom: 10px; cursor: pointer; text-align: left; transition: 0.2s; }
        .pkg-card:hover { border-color: black; background: #fafafa; }

        .hidden { display: none !important; }
        .login-card { max-width: 400px; margin: 100px auto; padding: 40px; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        
        @media (max-width: 768px) { .main-grid { grid-template-columns: 1fr; } }

        /* ==========================================
           ðŸ”˜ BUTTON â€” BORDER INNER GLOW + GRAIN
           ========================================== */
        .btn-primary, .btn-secondary {
            position: relative;
            overflow: hidden;
            isolation: isolate;
        }

        .btn-primary {
            box-shadow: inset 0 0 12px 3px rgba(255, 255, 255, 0.40), inset 0 0 28px 6px rgba(255, 255, 255, 0.12), 0 0 18px 4px rgba(167, 225, 105, 0.12);
        }
        .btn-primary:hover {
            box-shadow: inset 0 0 14px 4px rgba(255, 255, 255, 0.45), inset 0 0 32px 8px rgba(255, 255, 255, 0.15), 0 0 25px 6px rgba(237, 41, 57, 0.15);
        }

        .btn-secondary {
            box-shadow: inset 0 0 12px 3px rgba(255, 255, 255, 0.35), inset 0 0 28px 6px rgba(255, 255, 255, 0.10), 0 0 18px 4px rgba(237, 41, 57, 0.10);
        }
        .btn-secondary:hover {
            box-shadow: inset 0 0 14px 4px rgba(255, 255, 255, 0.45), inset 0 0 32px 8px rgba(255, 255, 255, 0.15), 0 0 25px 6px rgba(167, 225, 105, 0.18);
        }

        .btn-primary::after, .btn-secondary::after {
            content: '';
            position: absolute;
            inset: 0;
            z-index: 1;
            pointer-events: none;
            border-radius: inherit;
            opacity: 0.07;
            mix-blend-mode: overlay;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='g'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23g)'/%3E%3C/svg%3E");
            background-size: 128px 128px;
        }
        .btn-primary:hover::after, .btn-secondary:hover::after {
            opacity: 0.10;
        }
    </style>
</head>
<body>
    <!-- Login -->
    <div id="loginSection">
        <div class="login-card">
            <h2 style="text-align:center; margin-bottom:20px;">Client Login</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" class="form-input" required placeholder="your-email@gmail.com" />
                </div>
                <button type="submit" class="btn btn-primary">Login</button>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboardSection" class="hidden">
        <nav class="top-nav">
            <div class="nav-container">
                <div class="logo-section"><h1>ART de ONE</h1></div>
                <div class="nav-actions">
                    <button onclick="loadDashboard()" class="btn" style="background:#a7e169; color:black; margin-right:10px;">Refresh</button>
                    <button onclick="logout()" class="btn" style="background:#ffe4e6; color:#ed2939;">Logout</button>
                </div>
            </div>
        </nav>

        <div class="container">
            <div class="dashboard-header">
                <span style="position:absolute; top:20px; right:30px; background:black; color:white; padding:5px 10px; border-radius:15px; font-size:0.8em;">Client Dashboard</span>
                <h1 id="clientName">Welcome</h1>
                <p id="packageInfo">Loading...</p>
                <button onclick="openRenewModal()" class="btn" style="margin-top:10px; background:black; color:white; font-size:0.8em;">Renew Package</button>
            </div>

            <div class="stats">
                <div class="stat-card"><h3>Remaining</h3><div class="number" style="color:var(--accent-green)" id="revisionsRemaining">-</div></div>
                <div class="stat-card"><h3>Used</h3><div class="number" id="revisionsUsed">-</div></div>
                <div class="stat-card"><h3>Total</h3><div class="number" id="revisionsTotal">-</div></div>
            </div>

            <div class="main-grid">
                <!-- Form -->
                <div class="form-section">
                    <h2>New Revision Request</h2>
                    <form id="revisionForm">
                        <div class="form-group"><label>Project Name</label><input type="text" id="projectName" class="form-input" required /></div>
                        <div class="form-group"><label>Type</label>
                            <select id="revisionType" class="form-input" required>
                                <option value="alignment">Alignment / Spacing</option>
                                <option value="color">Color Correction</option>
                                <option value="layout">Layout Change</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group"><label>Details</label><textarea id="description" class="form-input" rows="4" required></textarea></div>
                        <div class="form-group"><label>File Link</label><input type="url" id="fileUrl" class="form-input" /></div>
                        <button type="submit" class="btn btn-primary">Submit Request</button>
                    </form>
                </div>

                <!-- History -->
                <div class="requests-section">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h2>History</h2>
                        <button onclick="loadRequests()" class="btn" style="background:#a7e169; color:black; padding:6px 12px; font-size:0.8em;">Refresh</button>
                    </div>
                    <div id="requestsList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Renew Modal -->
    <div class="modal-overlay" id="renewModal">
        <div class="modal-box">
            <h3 style="margin-bottom:15px;">Renew Package</h3>
            <p style="color:#666; margin-bottom:20px;">Select a package to continue.</p>
            <div class="pkg-card" onclick="submitRenew('essential')">
                <strong>Essential</strong> - 5 Revisions<br><small>50,000 MMK</small>
            </div>
            <div class="pkg-card" onclick="submitRenew('professional')">
                <strong>Professional</strong> - 15 Revisions<br><small>120,000 MMK</small>
            </div>
            <div class="pkg-card" onclick="submitRenew('freedom')">
                <strong>Freedom</strong> - Unlimited<br><small>200,000 MMK/Month</small>
            </div>
            <button onclick="document.getElementById('renewModal').classList.remove('active')" style="margin-top:10px; background:none; border:none; cursor:pointer;">Cancel</button>
        </div>
    </div>

    <script type="module">
        import { supabaseRevision, STATUS_TEXT, REVISION_TYPES } from './js/config-revision.js';
        let currentClient = null;

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            const email = sessionStorage.getItem('client_email');
            if (email) handleLogin(email);

            document.getElementById('loginForm').addEventListener('submit', (e) => {
                e.preventDefault();
                handleLogin(document.getElementById('loginEmail').value.trim());
            });

            document.getElementById('revisionForm').addEventListener('submit', handleSubmit);
        });

        window.logout = () => { sessionStorage.clear(); location.reload(); };

        async function handleLogin(email) {
            const { data } = await supabaseRevision.from('clients').select('*').eq('email', email).eq('is_active', true).single();
            if (data) {
                currentClient = data;
                sessionStorage.setItem('client_email', email);
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('dashboardSection').classList.remove('hidden');
                document.getElementById('dashboardSection').style.display = 'block';
                loadDashboard();
            } else {
                alert('Login failed');
            }
        }

        window.loadDashboard = async () => {
            const { data } = await supabaseRevision.from('clients').select('*').eq('id', currentClient.id).single();
            if (data) currentClient = data;

            document.getElementById('clientName').innerText = `Welcome, ${currentClient.name}`;
            document.getElementById('revisionsRemaining').innerText = currentClient.revisions_remaining;
            document.getElementById('revisionsUsed').innerText = currentClient.revisions_used;
            document.getElementById('revisionsTotal').innerText = currentClient.revisions_total;
            
            if(currentClient.package_end_date) {
                const days = Math.ceil((new Date(currentClient.package_end_date) - new Date()) / (1000 * 60 * 60 * 24));
                document.getElementById('packageInfo').innerText = `Expires: ${new Date(currentClient.package_end_date).toLocaleDateString()} (${days} days left)`;
            }
            loadRequests();
        };

        async function loadRequests() {
            const { data } = await supabaseRevision.from('revision_requests').select('*').eq('client_id', currentClient.id).order('created_at', { ascending: false });
            const list = document.getElementById('requestsList');
            list.innerHTML = data && data.length ? data.map(req => `
                <div class="request-item status-${req.status}">
                    <div style="display:flex; justify-content:space-between;">
                        <h3>${req.project_name}</h3>
                        <span style="font-size:0.8em; font-weight:bold; text-transform:uppercase;">${req.status}</span>
                    </div>
                    <p style="font-size:0.9em; color:#666;">${REVISION_TYPES[req.revision_type]}</p>
                    <p style="margin-top:5px;">${req.description}</p>
                </div>
            `).join('') : '<p>No requests yet.</p>';
        }

        async function handleSubmit(e) {
            e.preventDefault();
            if (currentClient.revisions_remaining <= 0) {
                if(confirm("Quota Exceeded! Renew Package?")) openRenewModal();
                return;
            }
            const { error } = await supabaseRevision.from('revision_requests').insert([{
                client_id: currentClient.id,
                project_name: document.getElementById('projectName').value,
                revision_type: document.getElementById('revisionType').value,
                description: document.getElementById('description').value,
                file_url: document.getElementById('fileUrl').value,
                status: 'pending'
            }]);
            if (!error) {
                alert('Request Submitted!');
                document.getElementById('revisionForm').reset();
                loadDashboard();
            }
        }

        window.openRenewModal = () => document.getElementById('renewModal').classList.add('active');
        
        window.submitRenew = async (pkg) => {
            if(!confirm(`Renew ${pkg}?`)) return;
            const { error } = await supabaseRevision.from('renew_requests').insert([{
                client_id: currentClient.id,
                requested_package: pkg,
                status: 'pending'
            }]);
            if(error) alert('Error');
            else { alert('Renewal Requested!'); document.getElementById('renewModal').classList.remove('active'); }
        };
    </script>
</body>
</html>
