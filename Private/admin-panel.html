<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - ART de ONE</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary-bg: #f8fafc;
            --sidebar-bg: #1e293b;
            --accent-green: #a7e169;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--primary-bg);
        }

        .sidebar {
            transition: all 0.3s ease;
        }

        .nav-link {
            transition: all 0.2s;
        }

        .nav-link:hover, .nav-link.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--accent-green);
        }

        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background-color: var(--accent-green);
            color: #1e293b;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }
        
        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-info { background: #e0f2fe; color: #075985; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        
        /* Modal Styles */
        .modal {
            transition: opacity 0.3s ease;
        }
        .modal.hidden {
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- SIDEBAR -->
    <aside class="sidebar w-64 bg-slate-800 text-white flex flex-col hidden md:flex">
        <div class="p-6 border-b border-slate-700">
            <h1 class="text-2xl font-bold text-green-400 tracking-wider">ART de ONE</h1>
            <p class="text-xs text-slate-400 mt-1">Admin Portal</p>
        </div>

        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <a href="#" class="nav-link active flex items-center gap-3 px-4 py-3 rounded-lg" data-section="dashboard" onclick="switchSection('dashboard')">
                <i class="fa-solid fa-gauge"></i> Dashboard
            </a>
            <a href="#" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg" data-section="students" onclick="switchSection('students')">
                <i class="fa-solid fa-users"></i> Students
            </a>
            <a href="#" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg" data-section="courses" onclick="switchSection('courses')">
                <i class="fa-solid fa-book-open"></i> Courses
            </a>
            <a href="#" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg" data-section="files" onclick="switchSection('files')">
                <i class="fa-solid fa-folder-open"></i> File Manager
            </a>
            <a href="#" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg" data-section="enrollments" onclick="switchSection('enrollments')">
                <i class="fa-solid fa-user-plus"></i> Enrollments
            </a>
            <a href="#" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg" data-section="announcements" onclick="switchSection('announcements')">
                <i class="fa-solid fa-bullhorn"></i> Announcements
            </a>
        </nav>

        <div class="p-4 border-t border-slate-700">
            <button onclick="logout()" class="w-full flex items-center justify-center gap-2 text-red-400 hover:bg-slate-700 py-2 rounded-lg transition-colors">
                <i class="fa-solid fa-right-from-bracket"></i> Logout
            </button>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 overflow-y-auto bg-slate-50 relative">
        <!-- Header -->
        <header class="bg-white shadow-sm sticky top-0 z-10 px-8 py-4 flex justify-between items-center">
            <h2 id="page-title" class="text-xl font-bold text-slate-800">Dashboard</h2>
            <div class="flex items-center gap-4">
                <span id="admin-email" class="text-sm text-slate-500 font-medium">admin@artdeone.com</span>
                <div class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center text-slate-600">
                    <i class="fa-solid fa-user-shield"></i>
                </div>
            </div>
        </header>

        <div class="p-8">
            <!-- ================= DASHBOARD SECTION ================= -->
            <section id="dashboard-section" class="section">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <!-- Stats Cards -->
                    <div class="card p-6 border-l-4 border-green-500">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm text-gray-500 mb-1">Total Students</p>
                                <h3 id="stat-students" class="text-3xl font-bold text-slate-800">0</h3>
                            </div>
                            <div class="p-3 bg-green-100 text-green-600 rounded-lg"><i class="fa-solid fa-users text-xl"></i></div>
                        </div>
                    </div>
                    <div class="card p-6 border-l-4 border-blue-500">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm text-gray-500 mb-1">Active Courses</p>
                                <h3 id="stat-courses" class="text-3xl font-bold text-slate-800">0</h3>
                            </div>
                            <div class="p-3 bg-blue-100 text-blue-600 rounded-lg"><i class="fa-solid fa-book text-xl"></i></div>
                        </div>
                    </div>
                    <div class="card p-6 border-l-4 border-purple-500">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm text-gray-500 mb-1">Enrollments</p>
                                <h3 id="stat-enrollments" class="text-3xl font-bold text-slate-800">0</h3>
                            </div>
                            <div class="p-3 bg-purple-100 text-purple-600 rounded-lg"><i class="fa-solid fa-graduation-cap text-xl"></i></div>
                        </div>
                    </div>
                    <div class="card p-6 border-l-4 border-orange-500">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm text-gray-500 mb-1">Course Files</p>
                                <h3 id="stat-files" class="text-3xl font-bold text-slate-800">0</h3>
                            </div>
                            <div class="p-3 bg-orange-100 text-orange-600 rounded-lg"><i class="fa-solid fa-file-lines text-xl"></i></div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity or other widgets can go here -->
                <div class="card p-8 text-center text-gray-500">
                    <i class="fa-solid fa-chart-line text-4xl mb-4 text-gray-300"></i>
                    <p>Welcome back! Here's what's happening with your students.</p>
                </div>
            </section>

            <!-- ================= STUDENTS SECTION ================= -->
            <section id="students-section" class="section hidden">
                <div class="card p-6">
                    <div class="flex justify-between items-center mb-6">
                        <div class="relative w-64">
                            <i class="fa-solid fa-search absolute left-3 top-3 text-gray-400"></i>
                            <input type="text" id="student-search" placeholder="Search students..." 
                                class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:border-green-400"
                                onkeyup="searchStudents()">
                        </div>
                        <button class="btn-primary" onclick="showAddStudentModal()">
                            <i class="fa-solid fa-plus mr-2"></i> Add Student
                        </button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="border-b border-gray-200 text-xs text-gray-500 uppercase">
                                    <th class="py-3 px-2">Student Name</th>
                                    <th class="py-3 px-2">Email</th>
                                    <th class="py-3 px-2 hidden md:table-cell">Phone</th>
                                    <th class="py-3 px-2">Type</th>
                                    <th class="py-3 px-2">Status</th>
                                    <th class="py-3 px-2 hidden md:table-cell">Joined Date</th>
                                    <th class="py-3 px-2 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="students-tbody" class="text-sm text-gray-700">
                                <!-- JS will populate this -->
                                <tr><td colspan="7" class="text-center py-4">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ================= COURSES SECTION ================= -->
            <section id="courses-section" class="section hidden">
                <!-- Similar Structure to Students -->
                <div class="card p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold">All Courses</h3>
                        <button class="btn-primary" onclick="showAddCourseModal()">
                            <i class="fa-solid fa-plus mr-2"></i> Create Course
                        </button>
                    </div>
                    <div id="courses-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- JS populated -->
                    </div>
                </div>
            </section>

            <!-- ================= ENROLLMENTS SECTION ================= -->
            <section id="enrollments-section" class="section hidden">
                <div class="card p-6">
                    <h3 class="text-lg font-bold mb-4">Manage Enrollments</h3>
                    <div class="bg-blue-50 p-4 rounded-lg mb-6 flex gap-4 items-end">
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-gray-600 mb-1">Select Student</label>
                            <select id="enroll-student-select" class="w-full p-2 border rounded"></select>
                        </div>
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-gray-600 mb-1">Select Course</label>
                            <select id="enroll-course-select" class="w-full p-2 border rounded"></select>
                        </div>
                        <button onclick="enrollStudent()" class="btn-primary py-2 px-6">Enroll</button>
                    </div>

                    <table class="w-full text-left">
                        <thead>
                            <tr class="border-b text-xs text-gray-500 uppercase">
                                <th class="py-2">Student</th>
                                <th class="py-2">Course</th>
                                <th class="py-2">Status</th>
                                <th class="py-2 text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody id="enrollments-tbody">
                            <!-- JS populated -->
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- Other sections (Files, Announcements) can be added similarly -->
             <section id="files-section" class="section hidden">
                <div class="card p-6 text-center">
                    <p class="text-gray-500">File Manager - Coming Soon (Implemented in Logic)</p>
                </div>
            </section>
             <section id="announcements-section" class="section hidden">
                <div class="card p-6 text-center">
                    <p class="text-gray-500">Announcements - Coming Soon</p>
                </div>
            </section>
        </div>
    </main>

    <!-- Modals (Simple implementations) -->
    <!-- Add Student Modal -->
    <div id="add-student-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
            <h3 class="text-lg font-bold mb-4">Add New Student</h3>
            <form id="add-student-form" class="space-y-4">
                <input type="email" id="new-student-email" placeholder="Email Address" class="w-full p-2 border rounded" required>
                <input type="password" id="new-student-password" placeholder="Password" class="w-full p-2 border rounded" required>
                <input type="text" id="new-student-name" placeholder="Full Name" class="w-full p-2 border rounded" required>
                <div class="flex justify-end gap-2 mt-4">
                    <button type="button" onclick="closeModal('add-student-modal')" class="px-4 py-2 text-gray-600">Cancel</button>
                    <button type="submit" class="btn-primary">Create Account</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Login Modal (If not logged in) -->
    <div id="login-modal" class="modal hidden fixed inset-0 bg-gray-900 flex items-center justify-center z-[60]">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-96 text-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Admin Login</h2>
            <p class="text-sm text-gray-500 mb-6">Access the management portal</p>
            <form id="admin-login-form" class="space-y-4 text-left">
                <div>
                    <label class="text-xs font-bold text-gray-600">Email</label>
                    <input type="email" id="login-email" class="w-full p-2 border rounded mt-1" required>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-600">Password</label>
                    <input type="password" id="login-password" class="w-full p-2 border rounded mt-1" required>
                </div>
                <button type="submit" class="w-full btn-primary py-2 mt-2">Sign In</button>
            </form>
        </div>
    </div>

<script type="module">
    import { supabase } from '../js/supabase-config.js';

    // Global State
    let allStudents = [];
    let allCourses = [];
    
    // Check Auth on Load
    window.addEventListener('load', async () => {
        const { data: { session } } = await supabase.auth.getSession();
        
        if (!session) {
            document.getElementById('login-modal').classList.remove('hidden');
        } else {
            initDashboard();
        }
    });

    async function initDashboard() {
        document.getElementById('login-modal').classList.add('hidden');
        await loadStudents();
        await loadCourses();
        await loadEnrollments();
        updateStats();
    }

    // Login Logic
    document.getElementById('admin-login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) {
            alert('Login failed: ' + error.message);
        } else {
            initDashboard();
        }
    });

    // ================= DATA LOADING =================

    // 1. Load Students (Fixed Display Logic)
    async function loadStudents() {
        try {
            const { data, error } = await supabase
                .from('students')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) throw error;
            allStudents = data;
            displayStudents(data);
            
            // Populate Dropdowns
            const studentSelect = document.getElementById('enroll-student-select');
            if(studentSelect) {
                studentSelect.innerHTML = data.map(s => 
                    `<option value="${s.student_id}">${s.name || s.full_name} (${s.email})</option>`
                ).join('');
            }
        } catch (error) {
            console.error('Error loading students:', error);
        }
    }

    // 2. Display Students Function (Fixed Columns)
    function displayStudents(students) {
        const tbody = document.getElementById('students-tbody');
        if (!tbody) return;

        if (students.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-6 text-gray-500">No students found</td></tr>';
            return;
        }

        tbody.innerHTML = students.map(s => `
            <tr class="hover:bg-gray-50 border-b border-gray-100 transition-colors">
                <td class="py-3 px-2 font-medium text-gray-800">
                    <div class="flex flex-col">
                        <span>${s.name || s.full_name || 'No Name'}</span>
                        <span class="text-xs text-gray-400 md:hidden">${s.student_id?.slice(0,8)}</span>
                    </div>
                </td>
                <td class="py-3 px-2 text-gray-600">${s.email || '-'}</td>
                <td class="py-3 px-2 text-gray-600 hidden md:table-cell">${s.phone || s.phone_number || '-'}</td>
                <td class="py-3 px-2"><span class="badge badge-info">${s.student_type || 'Student'}</span></td>
                <td class="py-3 px-2"><span class="badge ${s.status === 'active' ? 'badge-success' : 'badge-danger'}">${s.status || 'Active'}</span></td>
                <td class="py-3 px-2 text-gray-600 hidden md:table-cell">${s.created_at ? new Date(s.created_at).toLocaleDateString() : '-'}</td>
                <td class="py-3 px-2 text-right">
                    <button class="text-blue-500 hover:text-blue-700 p-1" onclick="viewStudent('${s.id}')" title="View Details">
                        <i class="fa-solid fa-eye"></i>
                    </button>
                    <!-- Add Edit/Delete buttons if needed -->
                </td>
            </tr>
        `).join('');
    }

    // 3. Load Courses
    async function loadCourses() {
        const { data, error } = await supabase.from('courses').select('*');
        if(!error) {
            allCourses = data;
            // Render Courses Grid (Simplified)
            const grid = document.getElementById('courses-grid');
            if(grid) {
                grid.innerHTML = data.map(c => `
                    <div class="border rounded-xl p-4 hover:shadow-md transition-shadow">
                        <h4 class="font-bold text-lg">${c.title}</h4>
                        <p class="text-sm text-gray-500 mb-2">${c.course_type}</p>
                        <div class="text-xs bg-gray-100 inline-block px-2 py-1 rounded">${c.status}</div>
                    </div>
                `).join('');
            }
            // Populate Dropdown
            const courseSelect = document.getElementById('enroll-course-select');
            if(courseSelect) {
                courseSelect.innerHTML = data.map(c => 
                    `<option value="${c.id}">${c.title} (${c.course_type})</option>`
                ).join('');
            }
        }
    }

    // 4. Load Enrollments
    async function loadEnrollments() {
        const { data, error } = await supabase
            .from('enrollments')
            .select('*, students(name, email), courses(title)')
            .order('enrolled_at', { ascending: false });
            
        if(!error) {
            const tbody = document.getElementById('enrollments-tbody');
            if(tbody) {
                tbody.innerHTML = data.map(e => `
                    <tr class="border-b">
                        <td class="py-2">${e.students?.name || 'Unknown'}</td>
                        <td class="py-2">${e.courses?.title || 'Unknown'}</td>
                        <td class="py-2"><span class="badge badge-success">${e.status}</span></td>
                        <td class="text-right">
                            <button onclick="deleteEnrollment('${e.enrollment_id}')" class="text-red-500 text-xs hover:underline">Revoke</button>
                        </td>
                    </tr>
                `).join('');
            }
        }
    }

    // ================= ACTIONS =================
    
    // View Student Modal Logic
    window.viewStudent = function(id) {
        const student = allStudents.find(s => s.id === id);
        if (student) {
            alert(`Student Details:\n
            ID: ${student.student_id || student.id}
            Name: ${student.name || student.full_name}
            Email: ${student.email}
            Phone: ${student.phone || student.phone_number || 'N/A'}
            Address: ${student.address || 'N/A'}
            Type: ${student.student_type}
            Status: ${student.status}
            Joined: ${new Date(student.created_at).toLocaleDateString()}`);
        }
    };

    window.searchStudents = function() {
        const query = document.getElementById('student-search').value.toLowerCase();
        const filtered = allStudents.filter(s => 
            (s.name || '').toLowerCase().includes(query) || 
            (s.email || '').toLowerCase().includes(query)
        );
        displayStudents(filtered);
    };

    // Enroll Student Action
    window.enrollStudent = async function() {
        const studentId = document.getElementById('enroll-student-select').value;
        const courseId = document.getElementById('enroll-course-select').value;
        
        try {
            const { error } = await supabase.from('enrollments').insert([{
                student_id: studentId,
                course_id: courseId,
                status: 'active',
                enrolled_at: new Date()
            }]);
            
            if(error) throw error;
            alert('Enrolled successfully!');
            loadEnrollments();
            updateStats();
        } catch(err) {
            alert('Enrollment failed: ' + err.message);
        }
    };

    // Stats
    function updateStats() {
        document.getElementById('stat-students').innerText = allStudents.length;
        document.getElementById('stat-courses').innerText = allCourses.length;
        // Enrollments count logic here
    }

    // Modal Helpers
    window.showAddStudentModal = () => document.getElementById('add-student-modal').classList.remove('hidden');
    window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
    
    // Create Student Logic
    document.getElementById('add-student-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('new-student-email').value;
        const password = document.getElementById('new-student-password').value;
        const name = document.getElementById('new-student-name').value;
        
        try {
            // 1. Create Auth User
            const { data: authData, error: authError } = await supabase.auth.signUp({
                email, password
            });
            if(authError) throw authError;

            // 2. Insert into students table
            if(authData.user) {
                const { error: dbError } = await supabase.from('students').insert([{
                    student_id: authData.user.id, // Important: Link Auth ID
                    email: email,
                    name: name,
                    student_type: 'Student',
                    status: 'active'
                }]);
                if(dbError) throw dbError;
                
                alert('Student created successfully!');
                closeModal('add-student-modal');
                loadStudents();
            }
        } catch(err) {
            alert('Error creating student: ' + err.message);
        }
    });

    // Navigation
    window.switchSection = function(sectionId) {
        // Update Title
        document.getElementById('page-title').innerText = sectionId.charAt(0).toUpperCase() + sectionId.slice(1);
        
        // Hide all sections
        document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
        // Show target
        const target = document.getElementById(sectionId + '-section');
        if(target) target.classList.remove('hidden');
        
        // Update Sidebar Active State
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        const activeLink = document.querySelector(`.nav-link[data-section="${sectionId}"]`);
        if(activeLink) activeLink.classList.add('active');
    };

    window.logout = async function() {
        await supabase.auth.signOut();
        window.location.reload();
    };

</script>
</body>
</html>
